---
title: "NFL Big Data Bowl 2022"
author: "Quinn MacLean"
output:
  html_document:
    df_print: paged
header-includes:
  - \usepackage{animate}
---

### Introduction
Jim Kelly once said, "There's not one person who's even been through our training camp who could cover him. Nobody could cover him one-on-one". Jim Kelly wasn't referring to Andre Reed (HoF WR) or James Lofton, he was referring to Steve Tasker who only had 51 career receptions over 14 years in the NFL. Steve Tasker was 5'9'' was arguably the best gunner in NFL history making 7 Pro Bowls and was the only special teams player to ever earn Pro Bowl MVP (1993). A gunner is a position on the special teams who's sole role is to break free from defenders during a punt to tackle the returner and limit their return yardage. The goal of my analysis is to build on the initial research done by Michael Lopez [build on the initial research done by Michael Lopez](https://operations.nfl.com/gameday/analytics/stats-articles/visualizing-the-special-teams-gunner/) to add specific metrics to evaluate Gunners in the NFL.   

We will be using 2020 tracking and scouting information to create four metrics to evaluate Gunner effectiveness during punts. The metrics are: \
1. Tackle Opportunity Probability Added \
2. Expected Gunner Distance at Punt Reception Under Expected \
3. Expected Return Yards Under Expected \
4. Expected Return Yards Under Exepcted (Returned Punts) \

These four metrics will help to measure which gunners put themselves in the best position to limit yardage from the returner, which is their ultimate job. 

### Tackle Opportunity Probability Added
The animated play below is 3 yard punt return where two Gunners, Nsimba Webster (#14) and David Long (#25), are vying to either limit return yardage, get a tackle opportunity or force a fair catch. In this example, Webster here is credited with the tackle. This visual helps to portray a common punt so we will use this play to illustrate gunner effectiveness. First, we want to define tackle opportunity (or involvement), which we've defined as either being the primary tackler, assist tackler, or even having a missed tackle. Regardless, involvement in tackling, whether converted or not, we believe is important to measure. 
```{r a1,echo=FALSE,warning=FALSE,message=FALSE}

library(tidyverse)
library(ggplot2)
library(gganimate)
library(cowplot)

### horizontal animation ###

sample<-read.csv("sample_tackle_prob.csv")


example_play<-sample





plot_field <- function(field_color="#006400", line_color = "#212529", number_color = "#ffffff") {
  field_height <- 160/3
  field_width <- 120
  
  field <- ggplot() +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, hjust = 0.5),
      plot.subtitle = element_text(hjust = 1),
      legend.position = "bottom",
      legend.title.align = 1,
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      axis.line = element_blank(),
      panel.background = element_rect(fill = field_color, color = "white"),
      panel.border = element_blank(),
      aspect.ratio = field_height/field_width
    ) +
    # major lines
    annotate(
      "segment",
      x = c(0, 0, 0,field_width, seq(10, 110, by=5)),
      xend = c(field_width,field_width, 0, field_width, seq(10, 110, by=5)),
      y = c(0, field_height, 0, 0, rep(0, 21)),
      yend = c(0, field_height, field_height, field_height, rep(field_height, 21)),
      colour = line_color
    ) +
    # hashmarks
    annotate(
      "segment",
      x = rep(seq(10, 110, by=1), 4),
      xend = rep(seq(10, 110, by=1), 4),
      y = c(rep(0, 101), rep(field_height-1, 101), rep(160/6 + 18.5/6, 101), rep(160/6 - 18.5/6, 101)),
      yend = c(rep(1, 101), rep(field_height, 101), rep(160/6 + 18.5/6 + 1, 101), rep(160/6 - 18.5/6 - 1, 101)),
      colour = line_color
    ) +
    # yard numbers
    annotate(
      "text",
      x = seq(20, 100, by = 10),
      y = rep(12, 9),
      label = c(seq(10, 50, by = 10), rev(seq(10, 40, by = 10))),
      size = 10,
      colour = number_color,
    ) +
    # yard numbers upside down
    annotate(
      "text",
      x = seq(20, 100, by = 10),
      y = rep(field_height-12, 9),
      label = c(seq(10, 50, by = 10), rev(seq(10, 40, by = 10))),
      angle = 180,
      size = 10,
      colour = number_color, 
    )
  
  return(field)
}


example_play$team_name<-as.character(example_play$team_name)
example_play$homeTeamAbbr<-as.character(example_play$homeTeamAbbr)
example_play$visitorTeamAbbr<-as.character(example_play$visitorTeamAbbr)
line_of_scrimmage = example_play$absoluteYardlineNumber
to_go_line = line_of_scrimmage - example_play$yardsToGo
df_colors = data.frame(home_1 = 'yellow',
                       home_2 = 'dark blue',
                       away_1 = 'blue',
                       away_2 = 'light grey')

example_play$frameId<-as.numeric(example_play$frameId)

play_frames<-plot_field() + 
  # line of scrimmage
  annotate(
    "segment",
    x = line_of_scrimmage, xend = line_of_scrimmage, y = 0, yend = 160/3,
    colour = "#0d41e1", size = 1.5
  ) +  # first down marker
  annotate(
    "segment",
    x = to_go_line, xend = to_go_line, y = 0, yend = 160/3,
    colour = "#f9c80e", size = 1.5
  )  +  # away team velocities
geom_segment(
  data = example_play %>% dplyr::filter(team_name == visitorTeamAbbr),
  mapping = aes(x = x, y = y, xend = x + dir_x, yend = y + dir_y),
  color = df_colors$away_1, size = 5, arrow = arrow(length = unit(1, "cm"),ends="last")
)  + # home team velocities
geom_segment(
  data = example_play %>% dplyr::filter(team_name == example_play$homeTeamAbbr),
  mapping = aes(x = x, y = y, xend = x + dir_x, yend = y + dir_y),
  colour = df_colors$home_2, size = 2, arrow = arrow(length = unit(0.03, "npc"))
) +  # away team locs and jersey numbers
geom_point(
  data = example_play %>% dplyr::filter(team_name == example_play$visitorTeamAbbr),
  mapping = aes(x = x, y = y),
  fill = "#f8f9fa", colour = df_colors$away_2,
  shape = 21, alpha = 0.7, size = 8, stroke = 1.5
)  + 
  geom_text(
  data = example_play %>% dplyr::filter(team_name == example_play$visitorTeamAbbr),
  mapping = aes(x = x, y = y, label = jerseyNumber),
  colour = df_colors$away_1, size = 4.5
) +
# home team locs and jersey numbers
geom_point(
  data = example_play %>% dplyr::filter(team_name == example_play$homeTeamAbbr),
  mapping = aes(x = x, y = y),
  fill = df_colors$home_1, colour = df_colors$home_2,
  shape = 21, alpha = 0.7, size = 8, stroke = 1.5
)  + geom_text(
  data = example_play %>% dplyr::filter(team_name == example_play$homeTeamAbbr),
  mapping = aes(x = x, y = y, label = jerseyNumber),
  colour = df_colors$home_2, size = 4.5 
)  + # ball
geom_point(
  data = example_play %>% dplyr::filter(team == "football"),
  mapping = aes(x = x, y = y),
  fill = "#935e38", colour = "#d9d9d9",
  shape = 21, alpha = 0.7, size = 6, stroke = 1
  ) +
  labs(title = "(12:54) J.Hekker punts 39 yards to NE 23, Center-J.McQuaide. G.Olszewski to NE 26 for 3 yards (N.Webster, J.Hollins)") +
  transition_time(frameId) +
  ease_aes('linear') +
  NULL


play_length <- length(unique(sample$frameId))



play_anim <- animate(
  play_frames,
  fps = 10, 
  nframes = play_length,
  width = 800,
  height = 400,
  end_pause = 0
)

play_anim


```

If we break down the tackle opportunity by frame, Webster had ~30% probability of a tackle at snap, ~28% at punt reception. Despite the ~0.02 probability added, we can see a wide variation in probability between that timeframe. At the lowest, the probability dropped 18% and the high we see a 30% probability (at the snap) and had ~25.3% average probability through the duration of the play. 

The reason for Webster's drop in probability to 18% was that he had beat his vises (#29) at the snap, #18 on the receiving team recognizes this and sealed the block. The increase back in probability is due to the fact that by gaining the attention of the second defender, he actually created a log jam at the receiver thus limiting his potential return yardage and increasing his probability of a tackle opportunity (Again, Webster was credited with the tackle). 

This scenario helps to paint a good picture of how critical the Gunner's are in tackling the returner.  

```{r a2,echo=FALSE,warning=FALSE,message=FALSE}




load("sample_gunner_tackle_animate.rdata")
sample_gunner_tackle_animate
# show play and visualization side by side with feature importance charts

```


In the scenario above, we showed results of the **Tackle Opportunity Probability model**, which can be used to evaluate Gunner's ability to put themselves in a better position for a tackle opportunity from snap to punt reception. 

For creating our model, we used NFL tracking data and filtered for the following:
1. Punt Plays
2. Using PFF data, filtering for those who were assigned as Gunner's
3. Filtering for catchable punts (filters out touchbacks)

Filtering out touchbacks helps us to model for plays where a gunner could have had a high probability of a tackle even in cases of a fair catch (where a high probability tackle opp is ).

In building our model, we included the following variables for consideration:
-Gunner's field position and direction variance
-Gunner's speed variance
-Distance from Line of Scrimmage (LOS)
-Distance from Ball
-Total distance travelled
-Avg. separation from key closest players
-Position Types on the field (# of Gunners, # of Vises)

Our final classification model is Gradient Boosted Machine (GBM) using down sampling, 10 cross fold validations, and 5 repeats to properly train the model and improve the performance of the model.  Gradient Boosted Machines is a machine learning technique that uses multiple learning algorithms with the goal of "boosting" or reducing bias and variance. It essentially convert weak learning models in a "boosted" or stronger one. The custom hyperparemter sampling techniques added helps to iterate through our decision trees to create the most accurate model possible. 

In our evaluating our model, we got a mean ROC score of 80.2, mean sensitivity score of 66.1%, and a mean specificity score of 80.6%. Essentially, our model is better at calculating non tackle opportunities than calculating tackle opportunities. 

Another way to interpret our model is through feature importance (Gini impurity), which helps to describe the decision tree nodes in order of relative importance. Basically, this helps to show what factors contribute the most to our prediction model. We can see that a player's distance to the ball, their position variance per second, and speed variance are the biggest factors that contribute to player's tackle opportunity probability. It's interesting to see that the number of total Vises on the receiving team doesn't have much importance in a gunner's Tackle Probability. 


```{r a3,echo=FALSE,warning=FALSE,message=FALSE}

library(gbm)
library(Metrics)
library(ggthemes)

GBM_lite<-readRDS("models/GBM_lite.rds")

Effects <- tibble::as_tibble(gbm::summary.gbm(GBM_lite$finalModel, 
                                         plotit = FALSE))

Effects<-Effects %>%
  mutate(var = recode(var,
                      ball_land_dis_from_player = "player distance to ball",
                      var_x = "x position variance",
                      var_s = "speed variance",
                      sum_dis = "total distance traveled",
                      closest_receiving_vises_separation = "distance between gunner to closest vise",
                      closest_receiving_vises_snap_separation =
"distance between gunner to closest vise at the snap",
var_dir_x = "angle of x position variance",
closest_punting_player_separation = "distance between gunner and closest player on punting team",
closest_punting_snap_separation = "distance between gunner and closest player on puting team at the snap",
var_s_theta = "angular velocity",
punt_dis_from_los = "punt distance from line of scrimmage",
ball_land_dis_from_los = "ball land distance from line of scrimmage",
closest_receiving_snap_separation = "gunner distance to closest opposing team player at snap",
Vises = "# of Vises on Receiving Team"
                      ))

Effects %>% 
  dplyr::arrange(desc(rel.inf)) %>%
  dplyr::top_n(15) %>%
  ggplot(aes(x = forcats::fct_reorder(.f = var,
                                      .x = rel.inf),
             y = rel.inf,
             fill = rel.inf)) +
  geom_col() +
  coord_flip() +
  scale_color_brewer(palette = "Dark2") +
  theme_classic() +
  theme(axis.title = element_text(),
        legend.position = "none",
        axis.text.x = element_text(size=6)) +
  xlab('Features') +
  ylab('Relative Influence') +
  labs(title = "Tackle Opportunity Feature Importance Model",size=10) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 50))









```

What this boils down to is the commitment to the angle of pursuit on the punt. We can see this by visualizing all of Webster's punt routes for received punts (Green representing tackles & Blue representing missed tackles). In the first few seconds of the snap, you see a rather clean angle being formed and that's due to the gunner's commit to the angle. 

```{r a4,echo=FALSE,warning=FALSE,message=FALSE}




data_model<-read.csv("ball_distance_pred.csv")
tracking_tacklers<-read.csv("data/tackler_tracking_2020.csv")
#players<-read.csv("players.csv")

tracking_tacklers<-tracking_tacklers %>%
  group_by(gameId,playId,nflId) %>%
  summarize(Tackler = sum(Tackler),
            AssistTackler = sum(AssistTackler),
            MissedTackler = sum(MissedTackler))

#data_model<-data_model %>%
#  left_join(players,by=c("nflId"))

pos_min<-data_model %>%
  group_by(gameId,playId,nflId) %>%
  summarize(min_x = min(x))

### webster 48784
data_model<-data_model %>%
  left_join(tracking_tacklers,by=c("gameId","playId","nflId")) 

#web<-data_model %>%
#  filter(nflId %in% c("48784","33234","38707"))

web<-data_model %>%  filter(nflId == "48784")

web<-web %>%
  left_join(pos_min,by=c("gameId","playId","nflId"))

#web<-web %>%
#  mutate(x = x - min_x)

web<-web %>%
  group_by(playId) %>%
  mutate(id = 1:n(),
         tackleOpp = ifelse(Tackler > 0,"Tackle",
                            ifelse(AssistTackler > 0,"AssistTackler",
                                   ifelse(MissedTackler > 0, "MissedTackler","No Tackle Opp"))))


web<-web %>%
  filter(id < 75)
####### FIELD #####

## General field boundaries
xmin <- 0
xmax <- 160/3
hash.right <- 38.35
hash.left <- 12
hash.width <- 3.3



## Specific boundaries for a given play
ymin <- max(round(min(web$x - web$min_x, na.rm = TRUE) - 10, -1), 0)
ymax <- min(round(max(web$x - web$min_x, na.rm = TRUE) + 10, -1), 120)
df_hash <- expand.grid(x = c(0, 23.36667, 29.96667, xmax), y = (10:110))
df_hash <- df_hash %>% filter(!(floor(y %% 5) == 0))
df_hash <- df_hash %>% filter(y < ymax, y > ymin)

animate_play <- ggplot() +
  scale_size_manual(values = c(6, 4, 6), guide = FALSE) + 
  scale_shape_manual(values = c(21, 16, 21), guide = FALSE) +
  scale_fill_manual(values = c("#e31837", "#654321", "#002244"), guide = FALSE) + 
  scale_colour_manual(values = c("black", "#654321", "#c60c30"), guide = FALSE) + 
  annotate("text", x = df_hash$x[df_hash$x < 55/2], 
           y = df_hash$y[df_hash$x < 55/2], label = "_", hjust = 0, vjust = -0.2) + 
  annotate("text", x = df_hash$x[df_hash$x > 55/2], 
           y = df_hash$y[df_hash$x > 55/2], label = "_", hjust = 1, vjust = -0.2) + 
  annotate("segment", x = xmin, 
           y = seq(max(10, ymin), min(ymax, 110), by = 5), 
           xend =  xmax, 
           yend = seq(max(10, ymin), min(ymax, 110), by = 5)) + 
  annotate("text", x = rep(hash.left, 11), y = seq(10, 110, by = 10), 
           label = c("G   ", seq(10, 50, by = 10), rev(seq(10, 40, by = 10)), "   G"), 
           angle = 270, size = 4) + 
  annotate("text", x = rep((xmax - hash.left), 11), y = seq(10, 110, by = 10), 
           label = c("   G", seq(10, 50, by = 10), rev(seq(10, 40, by = 10)), "G   "), 
           angle = 90, size = 4) + 
  annotate("segment", x = c(xmin, xmin, xmax, xmax), 
           y = c(ymin, ymax, ymax, ymin), 
           xend = c(xmin, xmax, xmax, xmin), 
           yend = c(ymax, ymax, ymin, ymin), colour = "black") + 
  geom_point(data = web %>% dplyr::filter(tackleOpp == "Tackle"), aes(x = (xmax-y) + 2.5, y = x - min_x + 10), alpha = 0.7,color="light green") + 
  geom_point(data = web %>% dplyr::filter(tackleOpp == "No Tackle Opp"), aes(x = (xmax-y) + 2.5, y = x - min_x + 10), alpha = 0.4,color="light grey") +
  geom_point(data = web %>% dplyr::filter(tackleOpp == "MissedTackler"), aes(x = (xmax-y) + 2.5, y = x - min_x + 10), alpha = 0.7,color="light blue") +
  ylim(ymin, ymax) + 
  coord_fixed() +  
  theme_nothing() + 
  transition_time(id)  +
  labs(title = "Nsima Webster's Punt Angles (Non Touchback Punts)") +
  shadow_mark() +
  ease_aes('linear') + 
  NULL

play.length.ex <- length(unique(web$id))
animate(animate_play, fps = 10, nframe = play.length.ex)



```

Pulling it all together, we see that Webster had the most Tackle Opps of all Gunners in 2020 for returnable punts. A big part of his ability to create more Tackle Opportunities is relatively high avg speed, higher variance in speed (i.e. angular speed), and higher separation from other vises. Contrary to Webster in strategy and alsoof note is Justin Bethel, who had the highest avg. Tackle Prob Added from snap to reception due to his high avg speed, low variance (usually straight shot in route). 
```{r a5,echo=FALSE,warning=FALSE,message=FALSE}

library(kableExtra)
top_players<-read.csv("top_players.csv")

top_players %>%
  select(-X,-fair.catch,-punt.received,-tp.mean,-dist..from.ball.land,-DtBUE,-RYUE,-RYUE..Non.Fair.catch.) %>%
  mutate(avg..speed = avg..speed * 2.04545,
         speed.variance = speed.variance * 2.04545) %>%
  rename(gunner = name,
         position = pos,
         `avg speed (mph)` = avg..speed,
         `speed var (mph)` = speed.variance,
         `avg vise separation (yds)` = avg..vise.separation,
         `Tackle Prob Added` = tpa,
         `Tackle Opps` = Tackle.Opp.,
         ) %>%
  mutate(`avg speed (mph)` = round(`avg speed (mph)`,2),
         `speed var (mph)` = round(`speed var (mph)`,2)) %>%
  kable(caption = "Top Gunner's of 2020") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  footnote(general = "Filter for Gunner%'s on at least 40 Punts for a year")


#### add time in first 4 seconds & Expected Tackle Opps

```

Add a pairplot of speed & direction variables to tackle prob

### Expected Gunner Distance at Punt Reception Model & Expected Return Yards
As we saw in the Tackle Opportunity Probability Model, the distance from the ball at first major event was one of the key features in determining probability of an expected tackle opportunity. As we can see in the distribution chart below, the distribution of Gunner's distance for each punt varies, which can be a key area for Gunner's to separate themselves in terms of improving their tackle opportunities, forcing fair catch or limiting return yardage. 

```{r a6,echo=FALSE,warning=FALSE,message=FALSE}



load("gpd.rdata")
gunner_position_dis



```

In looking at punts that were returned, we can see a small relationship of the Gunner's ability to limit return yardage if they are within 10 yards of the punt returner (wide variability in relating the two metrics to each other).
```{r a7,echo=FALSE,warning=FALSE,message=FALSE}

load("ball_dis_plot.rdata")
ball_dis_plot

```

This leads us to the creation of the "expected distance to ball" & "expected return yards" models, which were trained using a Random Forest. This helps us to understand, which players are best at angle of pursuit and best at limited return yardage. It also helps us visualize, which players did better than expected at first major event (i.e. Punt Reception or Fair Catch). The purpose of this model is to show, which players were better than expected in the pursuit, thus limiting return yardage and forcing fair catch. In our sample play below, the dashed grey line will show the expected ball distance for Nsima Webster (which resulted in a tackle). We can see that at the point of a ball kick, we get a prediction for his expected distance and expected return yardage
```{r a8,echo=FALSE,warning=FALSE,message=FALSE}



library(tidyverse)
library(gganimate)

## ball_distance_prod
data_model<-read_csv("ball_distance_pred.csv")

### return prod
dm<-read_csv("return_yards_pred.csv")


sample<-read_csv("sample_tackle_prob.csv")

#webster pred
gr1<-data_model %>% select(gameId,playId,nflId,frameId,ball_distance_pred) %>%
  filter(nflId == "48784") %>%
  rename(ball_distance_pred_gr1 = ball_distance_pred)

gr2<-data_model %>% select(gameId,playId,nflId,frameId,ball_distance_pred) %>%
  filter(nflId == "47862") %>%
  rename(ball_distance_pred_gr2 = ball_distance_pred)

return_prob<-dm %>% select(gameId,playId,nflId,frameId,return_yards_pred) %>%
  filter(nflId == "48784")


returner<-sample %>%
  select(gameId,playId,nflId,frameId,x,y) %>%
  filter(nflId == "48988") %>%
  rename(returner_x = x,
         returner_y = y)


example_play<-sample %>%
  left_join(gr1,sample,by=c("gameId","playId","frameId")) %>%
  left_join(gr2,sample,by=c("gameId","playId","frameId")) %>%
  left_join(returner,by=c("gameId","playId","frameId")) %>%
  left_join(return_prob,by=c("gameId","playId","frameId"))

example_play<-example_play %>%
  mutate(pred_pos_gr1 = returner_x - ball_distance_pred_gr1,
         pred_pos_gr2 = returner_x - ball_distance_pred_gr2,
         pred_return_yards = returner_x - return_yards_pred)

# from https://www.kaggle.com/adamsonty/nfl-big-data-bowl-a-basic-field-control-model



### horizontal animation ###








plot_field <- function(field_color="#006400", line_color = "#212529", number_color = "#ffffff") {
  field_height <- 160/3
  field_width <- 120
  
  field <- ggplot() +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 13, hjust = 0.5),
      plot.subtitle = element_text(hjust = 1),
      legend.position = "bottom",
      legend.title.align = 1,
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.title = element_blank(),
      axis.ticks = element_blank(),
      axis.text = element_blank(),
      axis.line = element_blank(),
      panel.background = element_rect(fill = field_color, color = "white"),
      panel.border = element_blank(),
      aspect.ratio = field_height/field_width
    ) +
    # major lines
    annotate(
      "segment",
      x = c(0, 0, 0,field_width, seq(10, 110, by=5)),
      xend = c(field_width,field_width, 0, field_width, seq(10, 110, by=5)),
      y = c(0, field_height, 0, 0, rep(0, 21)),
      yend = c(0, field_height, field_height, field_height, rep(field_height, 21)),
      colour = line_color
    ) +
    # hashmarks
    annotate(
      "segment",
      x = rep(seq(10, 110, by=1), 4),
      xend = rep(seq(10, 110, by=1), 4),
      y = c(rep(0, 101), rep(field_height-1, 101), rep(160/6 + 18.5/6, 101), rep(160/6 - 18.5/6, 101)),
      yend = c(rep(1, 101), rep(field_height, 101), rep(160/6 + 18.5/6 + 1, 101), rep(160/6 - 18.5/6 - 1, 101)),
      colour = line_color
    ) +
    # yard numbers
    annotate(
      "text",
      x = seq(20, 100, by = 10),
      y = rep(12, 9),
      label = c(seq(10, 50, by = 10), rev(seq(10, 40, by = 10))),
      size = 10,
      colour = number_color,
    ) +
    # yard numbers upside down
    annotate(
      "text",
      x = seq(20, 100, by = 10),
      y = rep(field_height-12, 9),
      label = c(seq(10, 50, by = 10), rev(seq(10, 40, by = 10))),
      angle = 180,
      size = 10,
      colour = number_color, 
    )
  
  return(field)
}

example_play$gr1<-"Nsima Webster (#14)"
example_play$gr2<-"David Long (#25)"
example_play$pred_return<-"Exp. Return Yards"
example_play$team_name<-as.character(example_play$team_name)
example_play$homeTeamAbbr<-as.character(example_play$homeTeamAbbr)
example_play$visitorTeamAbbr<-as.character(example_play$visitorTeamAbbr)
line_of_scrimmage = example_play$absoluteYardlineNumber
to_go_line = line_of_scrimmage - example_play$yardsToGo
df_colors = data.frame(home_1 = 'yellow',
                       home_2 = 'dark blue',
                       away_1 = 'blue',
                       away_2 = 'light grey')

example_play$frameId<-as.numeric(example_play$frameId)

play_frames<-plot_field() + 
  # line of scrimmage
  annotate(
    "segment",
    x = line_of_scrimmage, xend = line_of_scrimmage, y = 0, yend = 160/3,
    colour = "#0d41e1", size = 1.5
  ) +  # first down marker
  annotate(
    "segment",
    x = to_go_line, xend = to_go_line, y = 0, yend = 160/3,
    colour = "#f9c80e", size = 1.5
  )  +  # away team velocities
  geom_segment(
    data = example_play %>% dplyr::filter(team_name == visitorTeamAbbr),
    mapping = aes(x = x, y = y, xend = x + dir_x, yend = y + dir_y),
    color = df_colors$away_1, size = 5, arrow = arrow(length = unit(1, "cm"),ends="last")
  )  + # home team velocities
  geom_segment(
    data = example_play %>% dplyr::filter(team_name == example_play$homeTeamAbbr),
    mapping = aes(x = x, y = y, xend = x + dir_x, yend = y + dir_y),
    colour = df_colors$home_2, size = 2, arrow = arrow(length = unit(0.03, "npc"))
  ) +  # away team locs and jersey numbers
  geom_point(
    data = example_play %>% dplyr::filter(team_name == example_play$visitorTeamAbbr),
    mapping = aes(x = x, y = y),
    fill = "#f8f9fa", colour = df_colors$away_2,
    shape = 21, alpha = 0.7, size = 8, stroke = 1.5
  )  + ## gunner 1 pred
  geom_segment(
    data = example_play,
    mapping = aes(x = example_play$pred_pos_gr1, xend = example_play$pred_pos_gr1,y=0,yend = 160/3),
    color = "light grey",size = 1,lty =2
  ) + 
  geom_label(data=example_play, aes(x=example_play$pred_pos_gr1, y=50,  label = example_play$gr1),
             nudge_x = -2) +
  #gunner 2 pred
  geom_segment(
    data = example_play,
    mapping = aes(x = example_play$pred_pos_gr2, xend = example_play$pred_pos_gr2,y=0,yend = 160/3),
    color = "dark grey",size = 1,lty =2
  ) +
  geom_label(data=example_play, aes(x=example_play$pred_pos_gr2, y=0,  label = example_play$gr2),fill="dark grey",
             nudge_x = -2) +
   ## Returner Yards
  geom_segment(
    data = example_play,
    mapping = aes(x = example_play$pred_return_yards, xend = example_play$pred_return_yards,y=0,yend = 160/3),
    color = "red",size = 1,lty =2
  ) + 
  geom_label(data=example_play, aes(x=example_play$pred_return_yards, y=40,  label = example_play$pred_return),fill = "light grey",
             nudge_x = -3) +
  geom_text(
    data = example_play %>% dplyr::filter(team_name == example_play$visitorTeamAbbr),
    mapping = aes(x = x, y = y, label = jerseyNumber),
    colour = df_colors$away_1, size = 4.5
  ) +
  # home team locs and jersey numbers
  geom_point(
    data = example_play %>% dplyr::filter(team_name == example_play$homeTeamAbbr),
    mapping = aes(x = x, y = y),
    fill = df_colors$home_1, colour = df_colors$home_2,
    shape = 21, alpha = 0.7, size = 8, stroke = 1.5
  )  + geom_text(
    data = example_play %>% dplyr::filter(team_name == example_play$homeTeamAbbr),
    mapping = aes(x = x, y = y, label = jerseyNumber),
    colour = df_colors$home_2, size = 4.5 
  )  + # ball
  geom_point(
    data = example_play %>% dplyr::filter(team == "football"),
    mapping = aes(x = x, y = y),
    fill = "#935e38", colour = "#d9d9d9",
    shape = 21, alpha = 0.7, size = 6, stroke = 1
  ) +
  labs(title = example_play$playDescription[1]) +
  transition_time(frameId) +
  ease_aes('linear') +
  NULL


play_length <- length(unique(sample$frameId))



play_anim <- animate(
  play_frames,
  fps = 10, 
  nframes = play_length,
  width = 800,
  height = 400,
  end_pause = 0
)


play_anim



```


### Gunner's performance ###
Show bar chart show best BtBUE & RYUE

```{r a9,echo=FALSE,warning=FALSE,message=FALSE}

library(kableExtra)
top_players<-read.csv("top_players.csv")



top_players %>%
  ggplot(aes(x = DtBUE,
         y=RYUE)) +
  geom_point()
  
  


```

[Source Code](https://github.com/qmaclean/BDB_22)



Still to do:
-Add endzone logos for each team
-Add avg speed in first 4 seconds of punt
-Which plays have the best odds at the punt and why? 
-Rank Gunner's on all metrics


show Nsima Webster distribution of
expected ball distance

Show increase in probability due to shift in variables

Best in offset situations
